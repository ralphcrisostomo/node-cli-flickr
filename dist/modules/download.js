"use strict";var Download,ProgressBar,_,async,chalk,fs,mixin,request;_=require("lodash"),async=require("async"),request=require("superagent"),ProgressBar=require("progress"),chalk=require("chalk"),fs=require("fs"),mixin=require("./mixin"),Download=function(){function e(){this.retry=0}return e.prototype.run=function(e,n){return function(r){return function(t){return async.waterfall([r._getId(n),r._getPhoto(e),r._downloadVideo(n),r._updateManifest(n)],function(i,o){return"retry"===i?(mixin.write("red","\n------------------"),mixin.write("red","\nRetrying... ("+r.retry+")"),r.run(e,n)(t)):"continue"===i?r.run(e,n)(t):(r.retry=0,t(i,o))})}}(this)},e.prototype._getPhoto=function(e){return function(n){return function(r,t){var i;return i=r,e.photos.getSizes({api_key:process.env.FLICKR_API_KEY,photo_id:i.id},function(e,r){var o;return e?(n.retry++,mixin.write("cyan","\nStatus 		: Failed"),t("retry",null)):(console.log(r.sizes.size),o=_.findWhere(r.sizes.size,{label:"Large 2048"}),o||(o=_.findWhere(r.sizes.size,{label:"Large 1600"})),o||(o=_.findWhere(r.sizes.size,{label:"Large"})),o||(o=_.findWhere(r.sizes.size,{label:"Medium 640"})),o||(o=_.findWhere(r.sizes.size,{label:"Medium"})),_.assign(i,o),t(e,i))})}}(this)},e.prototype._getId=function(e){return function(n){var r,t,i,o;return i=process.cwd()+"/"+e+"/.manifest.json",o=require(i),r=_.filter(o,{status:"completed"}),t=_.find(o,{status:"created"}),_.isEmpty(t)?(mixin.write("green","\nDownload Complete"),n("completed",null)):(mixin.write("cyan","\n------------------"),mixin.write("cyan","\nIndex 		: "+((null!=r?r.length:void 0)+1)+" of "+(null!=o?o.length:void 0)),mixin.write("cyan","\nId 		: "+(null!=t?t.id:void 0)),mixin.write("cyan","\nName 		: "+(null!=t?t.name:void 0)),n(null,t))}},e.prototype._downloadVideo=function(e){return function(n){return function(r,t){var i,o;return i=r,o=i.source,mixin.write("cyan","\nUrl 		: "+o),request.get(o).parse(function(n){var r,o,u,s,a,l;return o=null!=(l=i.name+" ["+i.id+"].jpg")?l.replace(/\/+/g," "):void 0,a=process.cwd()+"/"+e,u=fs.createWriteStream(a+"/_"+o),s={complete:"=",incomplete:" ",width:20,total:parseInt(n.headers["content-length"],10)},r=new ProgressBar("Downloading 	: [:bar] :percent :etas",s),n.on("data",function(e){return r.tick(e.length)}),n.on("end",function(){return fs.rename(a+"/_"+o,a+"/"+o,function(e){return mixin.write("green","Downloaded 	: "+o),t(e,i)})}),n.pipe(u)}).end(function(e,r){return e?(n.retry++,t("retry",null)):void 0})}}(this)},e.prototype._updateManifest=function(e){return function(n,r){var t,i,o,u,s;return s=n,t=[],o=process.cwd()+"/"+e+"/.manifest.json",u=require(o),null!=u&&u.forEach(function(e){return parseInt(null!=e?e.id:void 0)===parseInt(null!=s?s.id:void 0)&&(e.status="completed"),t.push(e)}),i=_.filter(t,{status:"completed"}),fs.writeFile(o,JSON.stringify(t,null,4),function(e){return function(e){return i.length<=t.length?r("continue",s):r(null,s)}}(this))}},e}(),module.exports=Download;